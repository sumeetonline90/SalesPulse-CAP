sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/Input","sap/m/DatePicker","sap/m/Select","sap/ui/core/Item"],(e,t,s,r,o,a,n,i,l,d)=>{"use strict";return e.extend("com.sap.salespulse.salespulseui.controller.Main",{onInit(){this.getView().setModel(new r,"viewModel");setTimeout(()=>{this.refreshSalesData();this.refreshChart()},1e3)},onFileChange(e){const s=this.byId("fileUploader");const r=s.getDomRef();const o=r.querySelector('input[type="file"]');const a=this.byId("uploadButton");if(o&&o.files&&o.files.length>0){const e=o.files[0];a.setEnabled(true);t.show("File selected: "+e.name)}else{a.setEnabled(false)}},async onUpload(e){if(e&&e.preventDefault){e.preventDefault()}if(e&&e.stopPropagation){e.stopPropagation()}const s=this.byId("fileUploader");const r=s.getDomRef();const o=r.querySelector('input[type="file"]');if(!o||!o.files||o.files.length===0){t.show("Please select a file first");return}const a=o.files[0];if(!a.name.toLowerCase().endsWith(".xlsx")){t.show("Please select an Excel file (.xlsx)");return}t.show("Uploading file...");try{const e=await this.readFileAsBase64(a);const r=await fetch("/odata/v4/sales-service/",{method:"HEAD",headers:{"x-csrf-token":"Fetch"},credentials:"include"});const o=r.headers.get("x-csrf-token");if(!o){throw new Error("Failed to fetch CSRF token")}const n=await fetch("/odata/v4/sales-service/uploadExcel",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","x-csrf-token":o},credentials:"include",body:JSON.stringify({excel:e})});if(!n.ok){throw new Error(`HTTP ${n.status}: ${n.statusText}`)}const i=await n.json();const l=i.value||i||"File uploaded successfully!";t.show(l);setTimeout(()=>{this.refreshSalesData();this.refreshChart()},1500);s.clear();this.byId("uploadButton").setEnabled(false)}catch(e){console.error("Upload error:",e);t.show("Upload failed: "+e.message)}},readFileAsBase64(e){return new Promise((t,s)=>{const r=new FileReader;r.onload=e=>{try{const s=e.target.result.split(",")[1];t(s)}catch(e){s(new Error("Error processing file: "+e.message))}};r.onerror=()=>{s(new Error("Error reading file"))};r.readAsDataURL(e)})},onTypeMissmatch(e){t.show("Please select an Excel file (.xlsx)")},onRefresh(){this.refreshSalesData()},async onAddSampleData(){try{const e=await fetch("/odata/v4/sales-service/addSampleData",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({})});if(!e.ok){const t=await e.text();throw new Error(`HTTP ${e.status}: ${t}`)}const s=await e.json();const r=s.value||s;if(r){t.show(r);await this.refreshSalesData();await this.refreshChart()}}catch(e){console.error("Error adding sample data:",e);t.show("Error adding sample data: "+e.message)}},async refreshSalesData(){try{const e=this.getView().getModel();const s=this.byId("salesTable");if(e&&s){const e=s.getBinding("items");if(e){e.refresh()}else{s.bindItems({path:"/SalesOrders",template:s.getBindingInfo("items").template})}}else{t.show("Error: Unable to refresh data - model or table not found")}}catch(e){console.error("Error refreshing sales data:",e);t.show("Error refreshing data: "+e.message)}},onCreateOrder(){this._showOrderDialog()},onEditOrder(e){const t=e.getSource().getBindingContext();if(t){const e=t.getObject();this._showOrderDialog(e)}},onDeleteOrder(e){const t=e.getSource().getBindingContext();if(t){const e=t.getObject();s.confirm(`Are you sure you want to delete order ${e.OrderID}?`,{title:"Delete Order",onClose:t=>{if(t===s.Action.OK){this._deleteOrder(e)}}})}},_showOrderDialog(e=null){const t=!!e;const s=new o({title:t?"Edit Order":"Create New Order",contentWidth:"500px",content:[new n({id:"orderIdInput",placeholder:"Order ID",value:e?.OrderID||"",enabled:!t}),new n({id:"regionInput",placeholder:"Region",value:e?.Region||""}),new n({id:"countryInput",placeholder:"Country",value:e?.Country||""}),new n({id:"productInput",placeholder:"Product",value:e?.Product||""}),new n({id:"revenueInput",placeholder:"Revenue",value:e?.Revenue||"",type:"Number"}),new i({id:"orderDateInput",placeholder:"Order Date",value:e?.OrderDate||new Date})],beginButton:new a({text:t?"Update":"Create",type:"Emphasized",press:async()=>{try{await this._saveOrder(e);s.close();s.destroy()}catch(e){console.error("Error in dialog save:",e)}}}),endButton:new a({text:"Cancel",press:()=>{s.close();s.destroy()}})});s.open()},async _saveOrder(e){try{const s=this.byId("orderIdInput").getValue();const r=this.byId("regionInput").getValue();const o=this.byId("countryInput").getValue();const a=this.byId("productInput").getValue();const n=parseFloat(this.byId("revenueInput").getValue());const i=this.byId("orderDateInput").getValue();if(!s||!r||!o||!a||!n||!i){t.show("Please fill in all fields");return}const l={OrderID:s,Region:r,Country:o,Product:a,Revenue:n,OrderDate:i};if(e){const s=await fetch(`/odata/v4/sales-service/SalesOrders(${e.ID})`,{method:"PATCH",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(l)});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}t.show("Order updated successfully")}else{const e=await fetch("/odata/v4/sales-service/SalesOrders",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify(l)});if(!e.ok){const t=await e.text();throw new Error(`HTTP ${e.status}: ${t}`)}t.show("Order created successfully")}await this.refreshSalesData();await this.refreshChart()}catch(e){console.error("Error saving order:",e);t.show("Error saving order: "+e.message)}},async _deleteOrder(e){try{const s=await fetch(`/odata/v4/sales-service/SalesOrders(${e.ID})`,{method:"DELETE",headers:{Accept:"application/json"},credentials:"include"});if(!s.ok){const e=await s.text();throw new Error(`HTTP ${s.status}: ${e}`)}t.show("Order deleted successfully");await this.refreshSalesData();await this.refreshChart()}catch(e){console.error("Error deleting order:",e);t.show("Error deleting order: "+e.message)}},async onRefreshChart(){await this.refreshChart()},async refreshChart(){try{const e=await fetch("/odata/v4/sales-service/getGeographyData",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({})});if(!e.ok){const t=await e.text();throw new Error(`HTTP ${e.status}: ${t}`)}const t=await e.json();const s=t.value||t;if(s&&s.length>0){this._renderPieChart(s)}else{this._showNoDataMessage()}}catch(e){console.error("Error refreshing chart:",e);this._showNoDataMessage()}},_renderPieChart(e){const t=document.getElementById("chartContainer");if(!t)return;const s=e.reduce((e,t)=>e+parseFloat(t.totalRevenue),0);let r='<div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; height: 100%;">';e.forEach((e,t)=>{const o=(parseFloat(e.totalRevenue)/s*100).toFixed(1);const a=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F"];const n=a[t%a.length];r+=`\n                    <div style="display: flex; flex-direction: column; align-items: center; margin: 10px; padding: 15px; border-radius: 10px; background: ${n}20; border: 2px solid ${n}; min-width: 120px;">\n                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${n}; margin-bottom: 8px;"></div>\n                        <div style="font-weight: bold; font-size: 14px; color: #333; text-align: center;">${e.region}</div>\n                        <div style="font-size: 12px; color: #666; text-align: center;">${e.country}</div>\n                        <div style="font-weight: bold; font-size: 16px; color: #333; margin-top: 5px;">$${e.totalRevenue}</div>\n                        <div style="font-size: 12px; color: #666;">${o}%</div>\n                        <div style="font-size: 10px; color: #888;">${e.recordCount} orders</div>\n                    </div>\n                `});r+="</div>";t.innerHTML=r},_showNoDataMessage(){const e=document.getElementById("chartContainer");if(e){e.innerHTML=`\n                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666;">\n                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“Š</div>\n                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">No Data Available</div>\n                        <div style="font-size: 14px; text-align: center;">Upload some sales data to see the geography distribution chart</div>\n                    </div>\n                `}}})});
//# sourceMappingURL=Main.controller.js.map